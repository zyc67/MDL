<!--pages/payment/payment.wxml-->
<view class="container">
  <!-- è®¢å•ä¿¡æ¯ -->
  <view class="order-info">
    <view class="section-title">
      <text class="title-text">ğŸ“‹ è®¢å•ä¿¡æ¯</text>
    </view>
    <view class="order-item">
      <image class="order-image" src="{{orderInfo.image}}" mode="aspectFill" />
      <view class="order-content">
        <text class="order-title">{{orderInfo.title}}</text>
        <view class="order-details">
          <text class="order-time">ğŸ“… {{orderInfo.date}}</text>
          <text class="order-location">ğŸ“ {{orderInfo.location}}</text>
        </view>
        <view class="order-price-info">
          <text class="order-quantity">æ•°é‡ï¼š{{orderInfo.quantity}}</text>
          <view class="order-price">
            <text class="price-symbol">Â¥</text>
            <text class="price-amount">{{orderInfo.price}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å‚ä¸äººä¿¡æ¯ -->
  <view class="participant-info">
    <view class="section-title">
      <text class="title-text">ğŸ‘¥ å‚ä¸äººä¿¡æ¯</text>
      <text class="edit-btn" bindtap="editParticipants">ç¼–è¾‘</text>
    </view>
    <view class="participant-list">
      <view class="participant-item" wx:for="{{participants}}" wx:key="id">
        <view class="participant-details">
          <text class="participant-name">{{item.name}}</text>
          <text class="participant-id">èº«ä»½è¯ï¼š{{item.idCard}}</text>
          <text class="participant-phone">ç”µè¯ï¼š{{item.phone}}</text>
        </view>
        <view class="participant-type">{{item.type}}</view>
      </view>
    </view>
    <view class="add-participant" bindtap="addParticipant">
      <icon type="success" size="16" color="#4A90E2"></icon>
      <text>æ·»åŠ å‚ä¸äºº</text>
    </view>
  </view>

  <!-- è”ç³»äººä¿¡æ¯ -->
  <view class="contact-info">
    <view class="section-title">
      <text class="title-text">ğŸ“± è”ç³»äººä¿¡æ¯</text>
      <text class="edit-btn" bindtap="editContact">ç¼–è¾‘</text>
    </view>
    <view class="contact-details">
      <text class="contact-name">{{contactInfo.name}}</text>
      <text class="contact-phone">{{contactInfo.phone}}</text>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸ -->
  <view class="coupon-section">
    <view class="coupon-item" bindtap="selectCoupon">
      <view class="coupon-left">
        <icon type="success" size="20" color="#FF9500"></icon>
        <text class="coupon-text">
          {{selectedCoupon ? selectedCoupon.name : 'é€‰æ‹©ä¼˜æƒ åˆ¸'}}
        </text>
      </view>
      <view class="coupon-right">
        <text class="coupon-discount" wx:if="{{selectedCoupon}}">-Â¥{{selectedCoupon.discount}}</text>
        <icon type="search" size="16" color="#ccc"></icon>
      </view>
    </view>
  </view>

  <!-- è´¹ç”¨æ˜ç»† */
  <view class="cost-detail">
    <view class="section-title">
      <text class="title-text">ğŸ’° è´¹ç”¨æ˜ç»†</text>
    </view>
    <view class="cost-list">
      <view class="cost-item">
        <text class="cost-label">æ´»åŠ¨è´¹ç”¨</text>
        <text class="cost-value">Â¥{{costDetail.activityFee}}</text>
      </view>
      <view class="cost-item" wx:if="{{costDetail.serviceFee > 0}}">
        <text class="cost-label">æœåŠ¡è´¹</text>
        <text class="cost-value">Â¥{{costDetail.serviceFee}}</text>
      </view>
      <view class="cost-item" wx:if="{{costDetail.insuranceFee > 0}}">
        <text class="cost-label">ä¿é™©è´¹</text>
        <text class="cost-value">Â¥{{costDetail.insuranceFee}}</text>
      </view>
      <view class="cost-item discount" wx:if="{{costDetail.discount > 0}}">
        <text class="cost-label">ä¼˜æƒ åˆ¸å‡å…</text>
        <text class="cost-value">-Â¥{{costDetail.discount}}</text>
      </view>
      <view class="cost-divider"></view>
      <view class="cost-item total">
        <text class="cost-label">åº”ä»˜æ€»é¢</text>
        <text class="cost-value">Â¥{{costDetail.totalAmount}}</text>
      </view>
    </view>
  </view>

  <!-- æ”¯ä»˜æ–¹å¼ -->
  <view class="payment-method">
    <view class="section-title">
      <text class="title-text">ğŸ’³ æ”¯ä»˜æ–¹å¼</text>
    </view>
    <view class="method-list">
      <view 
        class="method-item {{selectedPayMethod === 'wechat' ? 'active' : ''}}" 
        bindtap="selectPayMethod" 
        data-method="wechat"
      >
        <image class="method-icon" src="https://img.icons8.com/color/60/wechat.png" />
        <text class="method-name">å¾®ä¿¡æ”¯ä»˜</text>
        <icon type="{{selectedPayMethod === 'wechat' ? 'success' : 'circle'}}" size="20" color="{{selectedPayMethod === 'wechat' ? '#4A90E2' : '#ccc'}}"></icon>
      </view>
      <view 
        class="method-item {{selectedPayMethod === 'alipay' ? 'active' : ''}}" 
        bindtap="selectPayMethod" 
        data-method="alipay"
      >
        <image class="method-icon" src="https://img.icons8.com/color/60/alipay.png" />
        <text class="method-name">æ”¯ä»˜å®</text>
        <icon type="{{selectedPayMethod === 'alipay' ? 'success' : 'circle'}}" size="20" color="{{selectedPayMethod === 'alipay' ? '#4A90E2' : '#ccc'}}"></icon>
      </view>
    </view>
  </view>

  <!-- åè®®ç¡®è®¤ */
  <view class="agreement-section">
    <view class="agreement-check" bindtap="toggleAgreement">
      <icon type="{{agreedToTerms ? 'success' : 'circle'}}" size="16" color="{{agreedToTerms ? '#4A90E2' : '#ccc'}}"></icon>
      <text class="agreement-text">
        æˆ‘å·²é˜…è¯»å¹¶åŒæ„
        <text class="agreement-link" bindtap="showTerms">ã€Šç ”å­¦æ´»åŠ¨åè®®ã€‹</text>
        å’Œ
        <text class="agreement-link" bindtap="showCancelPolicy">ã€Šé€€æ¬¾æ”¿ç­–ã€‹</text>
      </text>
    </view>
  </view>

  <!-- åº•éƒ¨å ä½ -->
  <view class="bottom-placeholder"></view>
</view>

<!-- åº•éƒ¨æ”¯ä»˜æ  -->
<view class="payment-bar">
  <view class="payment-info">
    <view class="payment-total">
      <text class="total-label">åº”ä»˜é‡‘é¢ï¼š</text>
      <text class="total-amount">Â¥{{costDetail.totalAmount}}</text>
    </view>
    <text class="payment-note" wx:if="{{paymentNote}}">{{paymentNote}}</text>
  </view>
  <button 
    class="pay-btn {{agreedToTerms && selectedPayMethod ? 'active' : 'disabled'}}" 
    disabled="{{!agreedToTerms || !selectedPayMethod || paying}}"
    bindtap="handlePayment"
  >
    {{paying ? 'æ”¯ä»˜ä¸­...' : 'ç«‹å³æ”¯ä»˜'}}
  </button>
</view>

<!-- å‚ä¸äººç¼–è¾‘å¼¹çª— -->
<view class="participant-modal {{showParticipantModal ? 'show' : ''}}" bindtap="hideParticipantModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç¼–è¾‘å‚ä¸äºº</text>
      <icon class="modal-close" type="clear" size="20" bindtap="hideParticipantModal"></icon>
    </view>
    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">å§“å</text>
        <input class="form-input" placeholder="è¯·è¾“å…¥å§“å" value="{{editingParticipant.name}}" bindinput="onParticipantNameInput" />
      </view>
      <view class="form-item">
        <text class="form-label">èº«ä»½è¯å·</text>
        <input class="form-input" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·" value="{{editingParticipant.idCard}}" bindinput="onParticipantIdInput" />
      </view>
      <view class="form-item">
        <text class="form-label">æ‰‹æœºå·</text>
        <input class="form-input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" value="{{editingParticipant.phone}}" bindinput="onParticipantPhoneInput" />
      </view>
      <view class="form-item">
        <text class="form-label">å‚ä¸äººç±»å‹</text>
        <picker class="form-picker" bindchange="onParticipantTypeChange" value="{{editingParticipant.typeIndex}}" range="{{participantTypes}}">
          <view class="picker-text">{{participantTypes[editingParticipant.typeIndex] || 'è¯·é€‰æ‹©'}}</view>
        </picker>
      </view>
    </view>
    <view class="modal-actions">
      <button class="modal-cancel" bindtap="hideParticipantModal">å–æ¶ˆ</button>
      <button class="modal-confirm btn-primary" bindtap="saveParticipant">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- ä¼˜æƒ åˆ¸é€‰æ‹©å¼¹çª— -->
<view class="coupon-modal {{showCouponModal ? 'show' : ''}}" bindtap="hideCouponModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©ä¼˜æƒ åˆ¸</text>
      <icon class="modal-close" type="clear" size="20" bindtap="hideCouponModal"></icon>
    </view>
    <view class="modal-body">
      <view class="coupon-list">
        <view 
          class="coupon-card {{selectedCouponId === item.id ? 'selected' : ''}}" 
          wx:for="{{availableCoupons}}" 
          wx:key="id"
          bindtap="chooseCoupon"
          data-id="{{item.id}}"
        >
          <view class="coupon-amount">Â¥{{item.discount}}</view>
          <view class="coupon-info">
            <text class="coupon-name">{{item.name}}</text>
            <text class="coupon-condition">{{item.condition}}</text>
            <text class="coupon-expire">æœ‰æ•ˆæœŸè‡³ï¼š{{item.expireDate}}</text>
          </view>
        </view>
        <view class="no-coupon {{selectedCouponId === null ? 'selected' : ''}}" bindtap="chooseCoupon" data-id="{{null}}">
          <text>ä¸ä½¿ç”¨ä¼˜æƒ åˆ¸</text>
        </view>
      </view>
    </view>
    <view class="modal-actions">
      <button class="modal-cancel" bindtap="hideCouponModal">å–æ¶ˆ</button>
      <button class="modal-confirm btn-primary" bindtap="confirmCoupon">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- åŠ è½½é®ç½© -->
<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view> 